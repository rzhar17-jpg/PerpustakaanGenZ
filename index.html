<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Perpustakaan Digital</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .book-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .book-card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .book-card-details {
            flex-grow: 1;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            animation: slide-up 0.3s ease-out;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .admin-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
        }
        .admin-controls button {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 9999px;
            padding: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .admin-controls button:hover {
            background-color: white;
        }
        .status-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-btn.active {
            background-color: #d97706; /* amber-600 */
            color: white;
        }
    </style>
</head>
<body class="antialiased text-slate-800 bg-gradient-to-br from-amber-50 to-white">
    <!-- Login & Register Screen -->
    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-amber-50 to-white z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="text-3xl font-bold text-center text-slate-900">Login</h2>
                <p class="text-center text-slate-500 mt-2 mb-6">Masuk untuk mengakses perpustakaan.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <!-- Label diubah untuk memperjelas input yang dibutuhkan -->
                        <label for="login-identifier" class="block text-sm font-medium text-slate-700 mb-1">Email (User) / Username (Admin)</label>
                        <input type="text" id="login-identifier" placeholder="user@example.com atau admin123" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                        <p class="text-xs text-slate-400 mt-1 italic">User biasa wajib menggunakan Email.</p>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <div id="login-error" class="text-red-500 text-sm text-center mb-4 min-h-[1.25rem]"></div>
                    <button type="submit" class="w-full bg-amber-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-amber-700 transition-colors shadow">Login</button>
                </form>
                <p class="text-center mt-4 text-sm text-slate-600">Belum punya akun? <button type="button" id="show-register-btn" class="font-semibold text-amber-600 hover:underline">Daftar di sini</button></p>
            </div>

            <!-- Register Form -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-3xl font-bold text-center text-slate-900">Daftar Akun Baru</h2>
                <p class="text-center text-slate-500 mt-2 mb-6">Buat akun untuk mulai meminjam buku.</p>
                <form id="register-form">
                     <div class="mb-4">
                        <label for="reg-username" class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                        <input type="text" id="reg-username" placeholder="Contoh: pembaca_buku" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="reg-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="reg-email" placeholder="nama@email.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="reg-password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" id="reg-password" minlength="8" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                         <p class="text-xs text-slate-500 mt-1">Minimal 8 karakter.</p>
                    </div>
                    <div id="register-error" class="text-red-500 text-sm text-center mb-4 min-h-[1.25rem]"></div>
                    <button type="submit" class="w-full bg-amber-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-amber-700 transition-colors shadow">Daftar</button>
                </form>
                 <p class="text-center mt-4 text-sm text-slate-600">Sudah punya akun? <button type="button" id="show-login-btn" class="font-semibold text-amber-600 hover:underline">Login di sini</button></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 hidden">
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900">E-Perpustakaan Digital</h1>
            <p class="mt-2 text-lg text-slate-600">Jelajahi koleksi buku kami dan temukan bacaan favoritmu.</p>
        </header>
        
        <!-- Top bar with user info and nav -->
        <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 mb-8 flex justify-between items-center sticky top-4 z-20">
             <span id="welcome-user" class="font-semibold text-slate-700 hidden sm:block"></span>
             <nav id="main-nav" class="flex items-center gap-2 sm:gap-4 bg-amber-100 p-1.5 rounded-full">
                <button data-page="home-page" class="nav-btn px-4 py-2 text-sm font-medium rounded-full transition-colors">Beranda</button>
                <button data-page="collection-page" class="nav-btn px-4 py-2 text-sm font-medium rounded-full transition-colors">Koleksi Buku</button>
                <button data-page="profile-page" class="nav-btn px-4 py-2 text-sm font-medium rounded-full transition-colors">Profil</button>
                <button id="manage-user-nav-btn" data-page="user-management-page" class="nav-btn hidden px-4 py-2 text-sm font-medium rounded-full transition-colors">Kelola Pengguna</button>
                <button id="reports-nav-btn" data-page="reports-page" class="nav-btn hidden px-4 py-2 text-sm font-medium rounded-full transition-colors">Laporan</button>
             </nav>
             <div class="flex items-center gap-2">
                 <button id="add-book-btn" class="hidden bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors shadow">Tambah Buku</button>
                 <button id="logout-btn" class="hidden bg-amber-100 text-amber-800 font-semibold py-2 px-4 rounded-lg hover:bg-amber-200 transition-colors">Logout</button>
             </div>
        </div>

        <!-- PAGE CONTENT -->
        <div id="page-content">
            <!-- Home Page -->
            <div id="home-page" class="page">
                <section class="bg-white rounded-xl shadow-sm p-8 text-center">
                    <h2 id="home-welcome-title" class="text-3xl font-bold text-slate-800">Selamat Datang!</h2>
                    <p class="text-slate-600 mt-2 max-w-2xl mx-auto">Ini adalah dasbor Anda. Lihat buku yang baru ditambahkan, atau langsung jelajahi seluruh koleksi kami untuk menemukan petualangan membaca Anda berikutnya.</p>
                </section>

                <section class="mt-10">
                    <h3 class="text-2xl font-bold text-slate-800 pb-2 mb-4">Baru Ditambahkan</h3>
                    <div id="newly-added-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-8">
                        <!-- Newly added books will be here -->
                    </div>
                </section>
            </div>

            <!-- Collection Page -->
            <div id="collection-page" class="page hidden">
                <!-- Search and Filter -->
                <div class="mb-8">
                    <div class="relative max-w-lg mx-auto">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <input type="text" id="search-input" placeholder="Cari judul atau penulis..." class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow">
                    </div>
                    <div id="filter-buttons" class="flex justify-center flex-wrap gap-2 mt-6">
                        <button data-category="Semua" class="filter-btn active-filter px-4 py-2 text-sm font-medium rounded-full bg-amber-600 text-white shadow">Semua</button>
                        <button data-category="Fiksi" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white text-slate-700 hover:bg-slate-100 shadow-sm border border-slate-200">Fiksi</button>
                        <button data-category="Non-Fiksi" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white text-slate-700 hover:bg-slate-100 shadow-sm border border-slate-200">Non-Fiksi</button>
                        <button data-category="Sains" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white text-slate-700 hover:bg-slate-100 shadow-sm border border-slate-200">Sains</button>
                        <button data-category="Biografi" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white text-slate-700 hover:bg-slate-100 shadow-sm border border-slate-200">Biografi</button>
                    </div>
                </div>

                <!-- Book Grid -->
                <main id="book-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-8">
                    <!-- Book cards will be inserted here by JavaScript -->
                </main>
                <div id="empty-state" class="text-center py-16 hidden">
                    <h3 class="text-xl font-semibold text-slate-700">Tidak Ada Buku Ditemukan</h3>
                    <p class="text-slate-500 mt-2">Coba ubah kata kunci pencarian atau filter kategori Anda.</p>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page hidden">
                 <!-- History Section (Admin Only) -->
                <section id="history-section" class="mb-10 hidden">
                    <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-amber-200 pb-2 mb-4">Riwayat Aktivitas Global</h2>
                    <div id="history-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- History items will be here -->
                    </div>
                    <p id="history-empty" class="text-center text-slate-500 py-6">Belum ada riwayat aktivitas.</p>
                </section>

                <!-- My Books Section -->
                <section id="my-books-section" class="mb-10 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-amber-200 pb-2">Buku Saya</h2>
                        <p id="my-books-count" class="text-slate-600 font-semibold"></p>
                    </div>
                    <div id="my-books-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- My borrowed/booked books will be here -->
                    </div>
                    <p id="my-books-empty" class="text-center text-slate-500 py-6">Anda belum meminjam atau booking buku apapun.</p>
                </section>

                <!-- Borrowing History Section (User Only) -->
                <section id="borrowing-history-section" class="mb-10 hidden">
                    <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-amber-200 pb-2 mb-4">Riwayat Peminjaman Saya</h2>
                    <div id="borrowing-history-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- Borrowing history items will be here -->
                    </div>
                    <p id="borrowing-history-empty" class="text-center text-slate-500 py-6 hidden">Anda belum memiliki riwayat peminjaman.</p>
                </section>
            </div>

            <!-- User Management Page (Admin Only) -->
            <div id="user-management-page" class="page hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Manajemen Pengguna</h2>
                     <!-- Add User button removed as Supabase handles user creation via sign-up -->
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b">
                                <tr>
                                    <th class="p-4 font-semibold">Username</th>
                                    <th class="p-4 font-semibold">Email</th>
                                    <th class="p-4 font-semibold">Peran</th>
                                    <th class="p-4 font-semibold text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-tbody">
                                <!-- User rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <!-- Pesan jika terjadi error RLS -->
                 <p id="rls-error-message" class="text-red-500 text-sm mt-4 text-center hidden">
                     Gagal memuat data pengguna. Jika Anda melihat error 'infinite recursion' di konsol, pastikan kebijakan RLS Supabase untuk tabel 'profiles' sudah benar. Lihat panduan setup.
                 </p>
            </div>

            <!-- Reports Page (Admin Only) -->
            <div id="reports-page" class="page hidden">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Laporan Perpustakaan</h2>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700">Total Buku</h3>
                            <p id="report-total-books" class="text-3xl font-bold text-amber-600">0</p>
                        </div>
                        <div class="bg-amber-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700">Buku Dipinjam</h3>
                            <p id="report-borrowed-books" class="text-3xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700">Buku Tersedia</h3>
                            <p id="report-available-books" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700">Total Pengguna</h3>
                            <p id="report-total-users" class="text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div>
                    </div>
                </div>

                <!-- Detailed Lists -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">Buku Paling Populer</h3>
                        <div id="report-popular-books" class="space-y-3">
                            <!-- Popular books list will be injected here -->
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">Buku Sedang Dipinjam</h3>
                        <div id="report-currently-borrowed" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                             <!-- Currently borrowed list will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Detail Modal -->
    <div id="book-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto flex flex-col md:flex-row">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition z-10"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <img id="modal-cover" src="" alt="Book Cover" class="w-full md:w-1/3 h-auto object-cover rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none">
            <div class="p-6 md:p-8 flex flex-col">
                <h2 id="modal-title" class="text-3xl font-bold text-slate-900"></h2>
                <p id="modal-author" class="text-lg text-slate-600 mt-1"></p>
                <span id="modal-category" class="text-sm font-semibold text-amber-800 bg-amber-100 px-3 py-1 rounded-full self-start my-4"></span>
                <p id="modal-description" class="text-slate-700 leading-relaxed overflow-y-auto"></p>
                <div id="modal-action-container" class="mt-auto pt-6">
                    <!-- Dynamic buttons will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Book Modal -->
    <div id="add-edit-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
             <form id="add-edit-form" class="p-8">
                 <h2 id="modal-form-title" class="text-2xl font-bold text-slate-900 mb-6">Tambah Buku Baru</h2>
                 <input type="hidden" id="book-id">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                         <label for="book-title" class="block text-sm font-medium text-slate-700 mb-1">Judul</label>
                         <input type="text" id="book-title" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                     </div>
                     <div>
                         <label for="book-author" class="block text-sm font-medium text-slate-700 mb-1">Penulis</label>
                         <input type="text" id="book-author" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                     </div>
                 </div>
                 <div class="mt-4">
                     <label for="book-category" class="block text-sm font-medium text-slate-700 mb-1">Kategori</label>
                     <select id="book-category" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                         <option>Fiksi</option>
                         <option>Non-Fiksi</option>
                         <option>Sains</option>
                         <option>Biografi</option>
                     </select>
                 </div>
                 <div class="mt-4">
                    <label for="book-cover-file" class="block text-sm font-medium text-slate-700 mb-1">Sampul Buku</label>
                    <div class="mt-2 flex items-center gap-4">
                        <img id="cover-preview" src="https://placehold.co/128x192/e2e8f0/94a3b8?text=Preview" alt="Cover Preview" class="w-24 h-36 object-cover rounded-md bg-slate-100">
                        <div class="w-full">
                            <input type="file" id="book-cover-file" class="w-full text-sm text-slate-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-amber-50 file:text-amber-700
                            hover:file:bg-amber-100" accept="image/*">
                            <p class="text-xs text-slate-500 mt-2">Pilih file gambar (JPG, PNG, dll.)</p>
                        </div>
                    </div>
                    <input type="hidden" id="book-cover-url"> <!-- To store the existing URL during edit -->
                 </div>
                 <div class="mt-4">
                     <label for="book-description" class="block text-sm font-medium text-slate-700 mb-1">Deskripsi</label>
                     <textarea id="book-description" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required></textarea>
                 </div>
                 <div class="mt-6 flex justify-end gap-3">
                     <button type="button" id="cancel-form-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300">Batal</button>
                     <button type="submit" class="bg-amber-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-amber-700">Simpan</button>
                 </div>
             </form>
        </div>
    </div>
    
    <!-- Edit User Role Modal -->
    <div id="edit-user-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
             <form id="edit-user-form" class="p-8">
                 <h2 id="modal-user-form-title" class="text-2xl font-bold text-slate-900 mb-6">Edit Peran Pengguna</h2>
                 <input type="hidden" id="user-id-to-edit">
                 <div class="space-y-4">
                     <div>
                         <label for="user-username-display" class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                         <input type="text" id="user-username-display" class="w-full px-3 py-2 border border-slate-300 rounded-md bg-slate-100" readonly>
                     </div>
                     <div>
                         <label for="user-role" class="block text-sm font-medium text-slate-700 mb-1">Peran</label>
                         <select id="user-role" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                             <option value="user">User</option>
                             <option value="admin">Admin</option>
                         </select>
                     </div>
                 </div>
                 <p id="user-form-error" class="text-red-500 text-sm text-center mt-4 h-5"></p>
                 <div class="mt-6 flex justify-end gap-3">
                     <button type="button" id="cancel-user-form-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300">Batal</button>
                     <button type="submit" class="bg-amber-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-amber-700">Simpan</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- User History Modal -->
    <div id="user-history-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                 <h2 id="user-history-title" class="text-2xl font-bold text-slate-900">Riwayat Peminjaman</h2>
            </div>
            <div id="user-history-list" class="p-6 space-y-2 overflow-y-auto">
                <!-- User history will be injected here -->
            </div>
            <div class="p-4 border-t mt-auto text-right">
                 <button id="close-user-history-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm text-center p-8">
            <h3 id="confirm-title" class="text-xl font-bold text-slate-900">Konfirmasi Hapus</h3>
            <p id="confirm-message" class="text-slate-600 mt-2 mb-6">Apakah Anda yakin ingin menghapus item ini?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300">Batal</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm text-center p-8">
            <h3 id="notification-title" class="text-xl font-bold text-slate-900">Pemberitahuan</h3>
            <p id="notification-message" class="text-slate-600 mt-2 mb-6">Pesan notifikasi.</p>
            <div class="flex justify-center">
                <button id="notification-ok-btn" class="bg-amber-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-amber-700">OK</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- SUPABASE SETUP ---
        // GANTI DENGAN URL DAN KUNCI ANON PROYEK SUPABASE ANDA
        const supabaseUrl = 'https://jnfeehtclzcitcqypcvh.supabase.co'; // <-- ISI URL SUPABASE ANDA DI SINI
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuZmVlaHRjbHpjaXRjcXlwY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjk1NTMsImV4cCI6MjA3NjUwNTU1M30.TgBl-TXmGnEqmhSuZfi4RS7oTRLjjVW63V5VRCroX4A'; // <-- ISI KUNCI ANON SUPABASE ANDA DI SINI

        if (!supabaseUrl || !supabaseKey || supabaseUrl.includes('https//example.com') || supabaseUrl.includes('YOUR_SUPABASE_URL')) {
            document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-800">
                <h1 class="text-2xl font-bold">Konfigurasi Supabase Diperlukan</h1>
                <p class="mt-2">Silakan buka file <code>index.html</code>, cari bagian "SUPABASE SETUP", dan isi variabel <code>supabaseUrl</code> dan <code>supabaseKey</code> dengan kredensial dari proyek Supabase Anda.</p>
                <p class="mt-4">Ikuti panduan di file <code>supabase_setup_guide.md</code> untuk menyiapkan database.</p>
                </div>`;
            
            // Tampilkan notifikasi jika ini adalah lingkungan pratinjau
            if (window.self !== window.top) { // Cek jika di dalam iframe
                 showNotificationModal("Konfigurasi Diperlukan", "Harap masukkan URL dan Kunci Anon Supabase Anda di dalam kode (baris 713-714) untuk menjalankan aplikasi.");
            }
            return;
        }

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);


        // --- DATA & STATE MANAGEMENT ---
        let books = [];
        let history = [];
        let profiles = []; // To store user profiles including roles
        let currentUserProfile = null; // Ini akan berisi { id, username, role } dari tabel profiles, atau null, atau object admin hardcoded
        let confirmCallback = null;
        let isHardcodedAdmin = false; // Flag untuk admin hardcoded
        let realtimeFallbackInterval = null; // Interval untuk polling jika realtime gagal

        // --- DOM ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const loginFormContainer = document.getElementById('login-form-container');
        const loginForm = document.getElementById('login-form');
        const loginIdentifierInput = document.getElementById('login-identifier'); // Input untuk username/email
        const loginError = document.getElementById('login-error');
        const registerFormContainer = document.getElementById('register-form-container');
        const registerForm = document.getElementById('register-form');
        const registerError = document.getElementById('register-error');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const appScreen = document.getElementById('app');
        const logoutBtn = document.getElementById('logout-btn');
        const addBookBtn = document.getElementById('add-book-btn');
        const welcomeUserEl = document.getElementById('welcome-user');
        const mainNav = document.getElementById('main-nav');
        const pages = document.querySelectorAll('.page');
        const bookGrid = document.getElementById('book-grid');
        const searchInput = document.getElementById('search-input');
        const filterButtonsContainer = document.getElementById('filter-buttons');
        const emptyState = document.getElementById('empty-state');
        const myBooksSection = document.getElementById('my-books-section');
        const myBooksGrid = document.getElementById('my-books-grid');
        const myBooksEmpty = document.getElementById('my-books-empty');
        const myBooksCount = document.getElementById('my-books-count');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const historyEmpty = document.getElementById('history-empty');
        const newlyAddedGrid = document.getElementById('newly-added-grid');
        const userListTbody = document.getElementById('user-list-tbody');
        const manageUserNavBtn = document.getElementById('manage-user-nav-btn');
        const reportsNavBtn = document.getElementById('reports-nav-btn');
        const borrowingHistorySection = document.getElementById('borrowing-history-section');
        const borrowingHistoryList = document.getElementById('borrowing-history-list');
        const borrowingHistoryEmpty = document.getElementById('borrowing-history-empty');
        const detailModal = document.getElementById('book-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalActionContainer = document.getElementById('modal-action-container');
        const addEditModal = document.getElementById('add-edit-modal');
        const addEditForm = document.getElementById('add-edit-form');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const modalFormTitle = document.getElementById('modal-form-title');
        const bookCoverFileInput = document.getElementById('book-cover-file');
        const bookCoverUrlInput = document.getElementById('book-cover-url');
        const coverPreview = document.getElementById('cover-preview');
        const editUserModal = document.getElementById('edit-user-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const cancelUserFormBtn = document.getElementById('cancel-user-form-btn');
        const userFormError = document.getElementById('user-form-error');
        const userHistoryModal = document.getElementById('user-history-modal');
        const userHistoryTitle = document.getElementById('user-history-title');
        const userHistoryList = document.getElementById('user-history-list');
        const closeUserHistoryBtn = document.getElementById('close-user-history-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const notificationOkBtn = document.getElementById('notification-ok-btn');
        const rlsErrorMessage = document.getElementById('rls-error-message'); // Element untuk pesan error RLS

        // --- PAGE NAVIGATION ---
        const showPage = (pageId) => {
            pages.forEach(page => {
                page.classList.toggle('hidden', page.id !== pageId);
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });

            if (pageId === 'collection-page') renderBooks();
            else if (pageId === 'profile-page') {
                renderMyBooks();
                renderHistory();
                renderBorrowingHistory();
            }
            else if (pageId === 'home-page') renderHomePage();
            else if (pageId === 'user-management-page') renderUserManagementPage();
            else if (pageId === 'reports-page') renderReportsPage();
        };

        mainNav.addEventListener('click', (e) => {
            if (e.target.matches('.nav-btn')) {
                showPage(e.target.dataset.page);
            }
        });

        // --- ACTION HANDLERS ---
        const handleBorrow = async (bookId) => {
            if (!currentUserProfile) return; // Pastikan user sudah login
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            const now = new Date();
            const dueDate = new Date();
            dueDate.setDate(now.getDate() + 7);

            const { error } = await supabaseClient.from('books').update({
                status: 'Dipinjam',
                borrowedBy: currentUserProfile.username,
                bookedBy: null,
                borrowDate: now.toISOString(),
                dueDate: dueDate.toISOString()
            }).eq('id', bookId);

            if (error) {
                console.error("Error borrowing book:", error);
                showNotificationModal('Error', 'Gagal meminjam buku.');
            } else {
                await logHistoryAction('Pinjam', book.title, currentUserProfile.username);
                hideDetailModal();
                showNotificationModal('Berhasil', `Anda telah berhasil meminjam "${book.title}".`);
                // Force update jika realtime gagal
                if (realtimeFallbackInterval) fetchInitialData();
            }
        };

        const handleReturn = async (bookId) => {
            if (!currentUserProfile) return; // Pastikan user sudah login
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            let updateData = {};
            if (book.bookedBy) {
                updateData = {
                    status: 'Dipesan',
                    borrowedBy: book.bookedBy,
                    bookedBy: null,
                    borrowDate: null,
                    dueDate: null
                };
            } else {
                updateData = {
                    status: 'Tersedia',
                    borrowedBy: null,
                    borrowDate: null,
                    dueDate: null
                };
            }

            const { error } = await supabaseClient.from('books').update(updateData).eq('id', bookId);

            if (error) {
                 console.error("Error returning book:", error);
                 showNotificationModal('Error', 'Gagal mengembalikan buku.');
            } else {
                await logHistoryAction('Kembalikan', book.title, currentUserProfile.username);
                hideDetailModal();
                if (realtimeFallbackInterval) fetchInitialData();
            }
        };

        const handleBook = async (bookId) => {
            if (!currentUserProfile) return; // Pastikan user sudah login
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            const { error } = await supabaseClient.from('books').update({
                bookedBy: currentUserProfile.username
            }).eq('id', bookId);

            if (error) {
                console.error("Error booking book:", error);
                showNotificationModal('Error', 'Gagal booking buku.');
            } else {
                await logHistoryAction('Booking', book.title, currentUserProfile.username);
                hideDetailModal();
                if (realtimeFallbackInterval) fetchInitialData();
            }
        };

        const handleCancelBooking = async (bookId) => {
            if (!currentUserProfile) return; // Pastikan user sudah login
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            const { error } = await supabaseClient.from('books').update({
                bookedBy: null
            }).eq('id', bookId);

            if (error) {
                console.error("Error canceling booking:", error);
                showNotificationModal('Error', 'Gagal membatalkan booking.');
            } else {
                await logHistoryAction('Batal Booking', book.title, currentUserProfile.username);
                hideDetailModal();
                if (realtimeFallbackInterval) fetchInitialData();
            }
        };

        const logHistoryAction = async (action, bookTitle, username) => {
             // Untuk admin hardcoded, jangan simpan history ke DB karena tidak punya user ID Supabase
             if (isHardcodedAdmin) {
                 console.log(`Admin action logged locally: ${action} - ${bookTitle}`);
                 // Anda bisa menyimpan log admin hardcoded ke array lokal jika perlu, tapi tidak ke Supabase
                 return;
             }
             // Hanya simpan history ke Supabase jika bukan admin hardcoded
             try {
                const { error } = await supabaseClient.from('history').insert([{ action, bookTitle, username }]);
                if (error) throw error;
             } catch (error) {
                 console.error("Error logging history:", error);
                 // Mungkin tampilkan notifikasi error ke admin jika gagal log?
             }
        };

        const createBookCard = (book) => {
            const isAdmin = currentUserProfile && currentUserProfile.role === 'admin';
            const statusColors = { 'Tersedia': 'bg-green-100 text-green-800', 'Dipinjam': 'bg-red-100 text-red-800', 'Dipesan': 'bg-yellow-100 text-yellow-800' };
            const statusBadge = `<div class="status-badge ${statusColors[book.status]}">${book.status}</div>`;
            const adminControls = isAdmin ? `<div class="admin-controls"><button class="edit-btn" data-id="${book.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="delete-btn" data-id="${book.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div>` : '';
            return `
            <div class="book-card bg-white rounded-lg shadow-md overflow-hidden" data-id="${book.id}">
                <div class="relative">
                    <img src="${book.coverUrl}" alt="${book.title}" class="w-full h-64 sm:h-72 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/slate/ffffff?text=Error';">
                    ${statusBadge}
                    ${adminControls}
                    <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center view-btn cursor-pointer" data-id="${book.id}">
                        <span class="text-white font-bold text-lg">Lihat Detail</span>
                    </div>
                </div>
                <div class="book-card-content p-4">
                    <div class="book-card-details">
                        <h3 class="font-bold text-md text-slate-800 truncate">${book.title}</h3>
                        <p class="text-sm text-slate-500">${book.author}</p>
                    </div>
                </div>
            </div>`;
        };

        // --- RENDER FUNCTIONS ---
        const renderHomePage = () => {
            // Pastikan currentUserProfile sudah terisi sebelum mengakses username
            if (currentUserProfile) {
                document.getElementById('home-welcome-title').innerText = `Selamat Datang, ${currentUserProfile.username}!`;
            } else {
                 document.getElementById('home-welcome-title').innerText = `Selamat Datang!`; // Fallback jika profile belum load
            }
            newlyAddedGrid.innerHTML = '';
            // Ambil 5 buku terbaru berdasarkan kolom 'created_at' dari Supabase jika tersedia
             const sortedBooks = [...books].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
             const newBooks = sortedBooks.slice(0, 5);
             newBooks.forEach(book => {
                newlyAddedGrid.innerHTML += createBookCard(book);
            });
        };

        const renderHistory = () => {
            // Cek role setelah currentUserProfile dipastikan ada
            if (!currentUserProfile || currentUserProfile.role !== 'admin') {
                historySection.classList.add('hidden');
                return;
            }
            historySection.classList.remove('hidden');
            historyList.innerHTML = '';

             // Ambil history terbaru dari state 'history' yang diupdate dari Supabase
            const sortedHistory = [...history].sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));


            if (sortedHistory.length === 0) {
                historyEmpty.classList.remove('hidden');
            } else {
                historyEmpty.classList.add('hidden');
                sortedHistory.forEach(log => {
                    const logDate = new Date(log.timestamp);
                    const formattedDate = `${logDate.toLocaleDateString('id-ID')} ${logDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    const actionColors = { 'Pinjam': 'text-amber-600', 'Kembalikan': 'text-green-600', 'Booking': 'text-yellow-600', 'Batal Booking': 'text-slate-600', 'Tambah Buku': 'text-purple-600', 'Edit Buku': 'text-orange-600', 'Hapus Buku': 'text-red-600' };
                    const logItem = `<div class="bg-white p-2 rounded-md shadow-sm flex justify-between items-center text-sm"><div><span class="font-semibold ${actionColors[log.action] || 'text-gray-800'}">${log.action}</span><span>: "${log.bookTitle}" oleh </span><span class="font-medium text-slate-800">${log.username}</span></div><div class="text-xs text-slate-500">${formattedDate}</div></div>`;
                    historyList.innerHTML += logItem;
                });
            }
        };

        const renderMyBooks = () => {
             // Cek role setelah currentUserProfile dipastikan ada
            if (!currentUserProfile || currentUserProfile.role !== 'user') {
                myBooksSection.classList.add('hidden');
                return;
            }
            myBooksSection.classList.remove('hidden');
            // Filter buku berdasarkan username dari currentUserProfile
            const userBooks = books.filter(b => b.borrowedBy === currentUserProfile.username);
            const userBookedBooks = books.filter(b => b.bookedBy === currentUserProfile.username);

            myBooksCount.textContent = `Total Dipinjam: ${userBooks.length}`;

            myBooksGrid.innerHTML = '';
            if (userBooks.length === 0 && userBookedBooks.length === 0) {
                myBooksEmpty.classList.remove('hidden');
            } else {
                myBooksEmpty.classList.add('hidden');

                const allUserBooks = [...userBooks, ...userBookedBooks];

                allUserBooks.forEach(book => {
                    let statusInfo = '', actionButton = '', details = '';

                    const formatDate = (dateString) => {
                        if (!dateString) return 'N/A';
                        const date = new Date(dateString);
                        return `${date.toLocaleDateString('id-ID')}, ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    };

                    if (book.status === 'Dipinjam' && book.borrowedBy === currentUserProfile.username) {
                        const dueDate = new Date(book.dueDate);
                        const isOverdue = new Date() > dueDate;

                        details = `
                            <div class="text-xs space-y-1 mt-2 text-slate-600">
                                <p><strong>Tgl. Pinjam:</strong> ${formatDate(book.borrowDate)}</p>
                                <p class="${isOverdue ? 'text-red-600 font-bold' : ''}"><strong>Jatuh Tempo:</strong> ${formatDate(book.dueDate)}</p>
                            </div>
                        `;
                        actionButton = `<button data-id="${book.id}" class="return-btn mt-3 w-full text-sm bg-green-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-green-600">Kembalikan</button>`;
                        statusInfo = `<div class="mt-2 text-sm font-semibold text-red-600">Status: Sedang Dipinjam</div>`;
                    } else if (book.bookedBy === currentUserProfile.username) {
                         statusInfo = `<div class="mt-2 text-sm font-semibold text-amber-600">Status: Anda Booking</div>`;
                         actionButton = `<button data-id="${book.id}" class="cancel-book-btn mt-3 w-full text-sm bg-slate-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-slate-600">Batalkan Booking</button>`;
                    }

                    const bookCard = `
                        <div class="book-card bg-white rounded-lg shadow-md overflow-hidden flex flex-row">
                            <img src="${book.coverUrl}" alt="${book.title}" class="w-1/3 h-auto object-cover view-btn cursor-pointer" data-id="${book.id}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/slate/ffffff?text=Error';">
                            <div class="p-4 flex flex-col justify-between w-2/3">
                                <div>
                                    <h3 class="font-bold text-md text-slate-800">${book.title}</h3>
                                    <p class="text-sm text-slate-500">${book.author}</p>
                                    ${statusInfo}
                                    ${details}
                                </div>
                                ${actionButton}
                            </div>
                        </div>`;
                    myBooksGrid.innerHTML += bookCard;
                });
            }
        };

        const renderBorrowingHistory = () => {
             // Cek role setelah currentUserProfile dipastikan ada
            if (!currentUserProfile || currentUserProfile.role !== 'user') {
                borrowingHistorySection.classList.add('hidden');
                return;
            }
            borrowingHistorySection.classList.remove('hidden');

            const userHistory = history.filter(log =>
                log.username === currentUserProfile.username &&
                (log.action === 'Pinjam' || log.action === 'Kembalikan')
            );

             // Urutkan riwayat berdasarkan timestamp terbaru
             userHistory.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

            borrowingHistoryList.innerHTML = '';
            if (userHistory.length === 0) {
                borrowingHistoryEmpty.classList.remove('hidden');
            } else {
                borrowingHistoryEmpty.classList.add('hidden');
                userHistory.forEach(log => {
                    const logDate = new Date(log.timestamp);
                    const formattedDate = `${logDate.toLocaleDateString('id-ID')} ${logDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    const actionColors = { 'Pinjam': 'text-amber-600', 'Kembalikan': 'text-green-600' };
                    const actionIcons = {
                        'Pinjam': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 flex-shrink-0"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
                        'Kembalikan': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 flex-shrink-0"><path d="m15 12-8.373 8.373a1 1 0 1 1-1.414-1.414L12.172 12 5.213 5.043a1 1 0 0 1 1.414-1.414L15 12z"></path></svg>`
                    };

                    const logItem = `
                    <div class="bg-white p-3 rounded-md shadow-sm flex justify-between items-center text-sm">
                        <div class="flex items-center">
                            <span class="${actionColors[log.action]}">${actionIcons[log.action] || ''}</span>
                            <div>
                                <span class="font-semibold ${actionColors[log.action] || 'text-gray-800'}">${log.action}</span>
                                <span class="text-slate-600">: "${log.bookTitle}"</span>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500">${formattedDate}</div>
                    </div>`;
                    borrowingHistoryList.innerHTML += logItem;
                });
            }
        };


        const renderUserManagementPage = async () => {
             // Cek role setelah currentUserProfile dipastikan ada
            if (!currentUserProfile || currentUserProfile.role !== 'admin') {
                showNotificationModal('Akses Ditolak', 'Hanya admin yang dapat mengakses halaman ini.');
                showPage('home-page'); // Redirect ke home jika bukan admin
                return;
            }

            // Reset pesan error RLS
             rlsErrorMessage.classList.add('hidden');

            // Ambil data users dari tabel 'profiles'
            // Gunakan state 'profiles' yang sudah di-fetch
            if (!profiles || profiles.length === 0 || isHardcodedAdmin) { // Juga cek jika admin hardcoded
                 // Coba fetch ulang jika kosong, mungkin data belum siap?
                 // Admin hardcoded tidak bisa fetch karena tidak punya auth.uid() Supabase
                 if (isHardcodedAdmin) {
                     userListTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">Manajemen pengguna tidak tersedia untuk admin hardcoded. Silakan login sebagai admin Supabase.</td></tr>';
                     return;
                 }

                 const { data: profilesData, error: profilesError } = await supabaseClient.from('profiles').select('*');
                 if (profilesError) {
                     console.error("Error fetching profiles:", profilesError);
                     if (profilesError.message.includes("infinite recursion")) {
                         rlsErrorMessage.classList.remove('hidden');
                     } else {
                        showNotificationModal('Error', 'Gagal mengambil data profil pengguna.');
                     }
                     userListTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Gagal memuat data pengguna.</td></tr>';
                     return;
                 }
                 profiles = profilesData || []; // Update state
            }


            userListTbody.innerHTML = '';
             if (!profiles || profiles.length === 0) {
                  userListTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">Tidak ada pengguna terdaftar.</td></tr>';
                  return;
             }

             // Urutkan profiles berdasarkan username
             const sortedProfiles = [...profiles].sort((a, b) => a.username.localeCompare(b.username));

            sortedProfiles.forEach(userProfile => {
                const isCurrentUser = !isHardcodedAdmin && userProfile.id === currentUserProfile.id; // Cek jika bukan admin hardcoded
                const roleBadge = userProfile.role === 'admin' 
                    ? `<span class="bg-amber-100 text-amber-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Admin</span>`
                    : `<span class="bg-slate-100 text-slate-800 text-xs font-medium px-2.5 py-0.5 rounded-full">User</span>`;
                
                 // Coba ambil email dari session user (jika ada, tidak reliable) atau tampilkan 'N/A'
                 // Email tidak ada di tabel 'profiles', jadi kita tampilkan 'N/A'
                 const userEmail = 'N/A (Cek Auth)';

                const actionButtons = `
                    <button class="view-history-btn p-1 text-gray-600 hover:text-gray-800" data-username="${userProfile.username}" title="Lihat Riwayat Peminjaman">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <button class="edit-user-btn p-1 text-amber-600 hover:text-amber-800" data-id="${userProfile.id}" data-username="${userProfile.username}" data-role="${userProfile.role}" title="Edit Peran Pengguna">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="delete-user-btn p-1 text-red-600 hover:text-red-800 ${isCurrentUser ? 'opacity-50 cursor-not-allowed' : ''}" ${isCurrentUser ? 'disabled' : ''} data-id="${userProfile.id}" data-username="${userProfile.username}" title="Hapus Pengguna (Profil Saja)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                `;

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-slate-50';
                row.innerHTML = `
                    <td class="p-4">${userProfile.username} ${isCurrentUser ? '<span class="text-xs text-slate-500">(Anda)</span>' : ''}</td>
                    <td class="p-4">${userEmail}</td>
                    <td class="p-4">${roleBadge}</td>
                    <td class="p-4 text-right space-x-2">${actionButtons}</td>
                `;
                userListTbody.appendChild(row);
            });
        };

        const renderReportsPage = () => {
             // Cek role setelah currentUserProfile dipastikan ada
            if (!currentUserProfile || currentUserProfile.role !== 'admin') {
                showNotificationModal('Akses Ditolak', 'Hanya admin yang dapat mengakses halaman ini.');
                showPage('home-page'); // Redirect ke home jika bukan admin
                return;
            }

            // Summary Cards
            const totalBooks = books.length;
            const borrowedBooksCount = books.filter(b => b.status === 'Dipinjam').length;
            const availableBooksCount = totalBooks - borrowedBooksCount;
            const totalUsers = profiles.length; // Hitung dari state profiles
            document.getElementById('report-total-books').textContent = totalBooks;
            document.getElementById('report-borrowed-books').textContent = borrowedBooksCount;
            document.getElementById('report-available-books').textContent = availableBooksCount;
            document.getElementById('report-total-users').textContent = totalUsers;

            // Most Popular Books (menggunakan state history)
            const borrowCounts = history.filter(h => h.action === 'Pinjam')
                .reduce((acc, h) => {
                    acc[h.bookTitle] = (acc[h.bookTitle] || 0) + 1;
                    return acc;
                }, {});
            
            const sortedBooks = Object.entries(borrowCounts)
                .sort(([,a],[,b]) => b-a)
                .slice(0, 5);

            const popularBooksContainer = document.getElementById('report-popular-books');
            popularBooksContainer.innerHTML = '';
            if (sortedBooks.length === 0) {
                popularBooksContainer.innerHTML = `<p class="text-center text-slate-500 py-6">Belum ada buku yang dipinjam.</p>`;
            } else {
                sortedBooks.forEach(([title, count], index) => {
                    popularBooksContainer.innerHTML += `
                        <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                            <div class="flex items-center">
                                <span class="font-bold text-slate-600 w-8">${index + 1}.</span>
                                <span class="font-semibold text-slate-800">${title}</span>
                            </div>
                            <span class="font-bold text-amber-800 bg-amber-100 px-2 py-0.5 rounded-md text-sm">${count} kali</span>
                        </div>
                    `;
                });
            }

            // Currently Borrowed Books (menggunakan state books)
            const currentlyBorrowed = books.filter(b => b.status === 'Dipinjam');
            const borrowedContainer = document.getElementById('report-currently-borrowed');
            borrowedContainer.innerHTML = '';
            if (currentlyBorrowed.length === 0) {
                borrowedContainer.innerHTML = `<p class="text-center text-slate-500 py-6">Tidak ada buku yang sedang dipinjam.</p>`;
            } else {
                 currentlyBorrowed.sort((a, b) => new Date(a.dueDate || 0) - new Date(b.dueDate || 0)); // Urutkan berdasarkan jatuh tempo
                currentlyBorrowed.forEach(book => {
                    const dueDate = new Date(book.dueDate);
                    const isOverdue = new Date() > dueDate;
                    borrowedContainer.innerHTML += `
                        <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                            <div>
                                <p class="font-semibold text-slate-800">${book.title}</p>
                                <p class="text-sm text-slate-500">oleh <span class="font-medium">${book.borrowedBy}</span></p>
                            </div>
                            <p class="text-sm font-semibold ${isOverdue ? 'text-red-600' : 'text-slate-600'}">
                                ${isOverdue ? 'Telat!' : 'Tempo:'} ${dueDate.toLocaleDateString('id-ID')}
                            </p>
                        </div>
                    `;
                });
            }
        };
        
        const renderBooks = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active-filter').dataset.category;
            let booksToRender = books;
            if (activeCategory !== 'Semua') booksToRender = booksToRender.filter(b => b.category === activeCategory);
            if (searchTerm) booksToRender = booksToRender.filter(b => b.title.toLowerCase().includes(searchTerm) || b.author.toLowerCase().includes(searchTerm));
            bookGrid.innerHTML = '';
            if (booksToRender.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                 // Urutkan buku yang akan ditampilkan, misal berdasarkan judul
                 booksToRender.sort((a, b) => a.title.localeCompare(b.title));
                booksToRender.forEach(book => {
                    bookGrid.innerHTML += createBookCard(book);
                });
            }
        };

        const renderAllActivePages = () => {
            const activePage = document.querySelector('.page:not(.hidden)');
            if (activePage) {
                showPage(activePage.id);
            } else if (currentUserProfile) { // Jika tidak ada halaman aktif tapi user login, tampilkan home
                 showPage('home-page');
            }
        };

        // --- MODAL & UI VISIBILITY ---
        const showDetailModal = (bookId) => {
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            document.getElementById('modal-cover').src = book.coverUrl;
            document.getElementById('modal-title').innerText = book.title;
            document.getElementById('modal-author').innerText = `oleh ${book.author}`;
            document.getElementById('modal-category').innerText = book.category;
            document.getElementById('modal-description').innerText = book.description;

            modalActionContainer.innerHTML = '';
            // Pastikan currentUserProfile ada sebelum cek role
            const isUser = currentUserProfile && currentUserProfile.role === 'user';

            if (isUser) {
                if (book.status === 'Tersedia') {
                    modalActionContainer.innerHTML = `<button id="borrow-btn" class="w-full bg-amber-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-amber-700 transition-colors">Pinjam Buku</button>`;
                    modalActionContainer.querySelector('#borrow-btn').onclick = () => handleBorrow(book.id);
                } else if (book.status === 'Dipinjam') {
                    if (book.borrowedBy === currentUserProfile.username) {
                        modalActionContainer.innerHTML = `<button id="return-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">Kembalikan Buku</button>`;
                        modalActionContainer.querySelector('#return-btn').onclick = () => handleReturn(book.id);
                    } else if (!book.bookedBy) {
                        modalActionContainer.innerHTML = `<button id="book-btn" class="w-full bg-amber-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-amber-700 transition-colors">Booking Buku</button>`;
                        modalActionContainer.querySelector('#book-btn').onclick = () => handleBook(book.id);
                    } else if (book.bookedBy === currentUserProfile.username) {
                        modalActionContainer.innerHTML = `<button id="cancel-book-btn" class="w-full bg-slate-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-slate-600 transition-colors">Batalkan Booking</button>`;
                        modalActionContainer.querySelector('#cancel-book-btn').onclick = () => handleCancelBooking(book.id);
                    } else {
                         modalActionContainer.innerHTML = `<p class="text-center text-slate-600">Buku sedang dipinjam oleh ${book.borrowedBy} dan sudah di-booking oleh ${book.bookedBy}.</p>`;
                    }
                } else if (book.status === 'Dipesan') {
                     if (book.borrowedBy === currentUserProfile.username) {
                        modalActionContainer.innerHTML = `<button id="borrow-btn" class="w-full bg-amber-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-amber-700 transition-colors">Ambil & Pinjam Buku</button>`;
                        modalActionContainer.querySelector('#borrow-btn').onclick = () => handleBorrow(book.id);
                     } else if (book.bookedBy === currentUserProfile.username) {
                        modalActionContainer.innerHTML = `<p class="text-center text-slate-600">Anda telah booking buku ini. Tunggu hingga tersedia.</p>`;
                    } else {
                        modalActionContainer.innerHTML = `<p class="text-center text-slate-600">Buku ini sudah dipesan oleh ${book.borrowedBy}.</p>`;
                    }
                }
            } else { // Admin or not logged in
                modalActionContainer.innerHTML = `<p class="text-center text-slate-500">Login sebagai pengguna untuk meminjam buku.</p>`;
            }
            detailModal.classList.remove('hidden');
        };

        const hideDetailModal = () => detailModal.classList.add('hidden');
        
        const showAddEditModal = (bookToEdit = null) => {
            addEditForm.reset();
            coverPreview.src = 'https://placehold.co/128x192/e2e8f0/94a3b8?text=Preview';
            bookCoverUrlInput.value = '';
            if (bookToEdit) {
                modalFormTitle.innerText = 'Edit Buku';
                document.getElementById('book-id').value = bookToEdit.id;
                document.getElementById('book-title').value = bookToEdit.title;
                document.getElementById('book-author').value = bookToEdit.author;
                document.getElementById('book-category').value = bookToEdit.category;
                document.getElementById('book-description').value = bookToEdit.description;
                coverPreview.src = bookToEdit.coverUrl;
                bookCoverUrlInput.value = bookToEdit.coverUrl;
            } else {
                modalFormTitle.innerText = 'Tambah Buku Baru';
                document.getElementById('book-id').value = '';
            }
            addEditModal.classList.remove('hidden');
        };

        const hideAddEditModal = () => addEditModal.classList.add('hidden');

        const showEditUserModal = (id, username, role) => {
            editUserForm.reset();
            userFormError.textContent = '';
            document.getElementById('user-id-to-edit').value = id;
            document.getElementById('user-username-display').value = username;
            document.getElementById('user-role').value = role;
            editUserModal.classList.remove('hidden');
        };

        const hideEditUserModal = () => editUserModal.classList.add('hidden');

        const showUserHistoryModal = (username) => {
            userHistoryTitle.innerHTML = `Riwayat Peminjaman: <span class="font-bold text-amber-600">${username}</span>`;
            const userHistory = history.filter(log => log.username === username && (log.action === 'Pinjam' || log.action === 'Kembalikan'));
            // Urutkan history terbaru di atas
             userHistory.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

            userHistoryList.innerHTML = '';
            if (userHistory.length === 0) {
                userHistoryList.innerHTML = `<p class="text-center text-slate-500 py-6">Pengguna ini belum memiliki riwayat peminjaman.</p>`;
            } else {
                userHistory.forEach(log => {
                    const logDate = new Date(log.timestamp);
                    const formattedDate = `${logDate.toLocaleDateString('id-ID')} ${logDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    const actionColors = { 'Pinjam': 'text-amber-600', 'Kembalikan': 'text-green-600' };
                     const logItem = `<div class="bg-slate-50 p-3 rounded-md flex justify-between items-center text-sm"><div><span class="font-semibold ${actionColors[log.action]}">${log.action}</span>: "${log.bookTitle}"</div><div class="text-xs text-slate-500">${formattedDate}</div></div>`;
                    userHistoryList.innerHTML += logItem;
                });
            }
            userHistoryModal.classList.remove('hidden');
        };

        const hideUserHistoryModal = () => userHistoryModal.classList.add('hidden');

        const showConfirmModal = (title, message, onConfirm) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        };

        const hideConfirmModal = () => confirmModal.classList.add('hidden');

        const showNotificationModal = (title, message) => {
            notificationTitle.innerText = title;
            notificationMessage.innerText = message;
            notificationModal.classList.remove('hidden');
        };
        const hideNotificationModal = () => notificationModal.classList.add('hidden');


        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', renderBooks);
        
        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter', 'bg-amber-600', 'text-white'));
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.add('bg-white', 'text-slate-700'));
                e.target.classList.add('active-filter', 'bg-amber-600', 'text-white');
                e.target.classList.remove('bg-white', 'text-slate-700');
                renderBooks();
            }
        });

        document.getElementById('page-content').addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-btn');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const returnBtn = e.target.closest('.return-btn');
            // 'borrow-btn' sekarang hanya ada di detail modal, tidak di card 'My Books'
            const cancelBtn = e.target.closest('.cancel-book-btn');

            if (viewBtn) showDetailModal(parseInt(viewBtn.dataset.id));
            else if (editBtn) {
                const book = books.find(b => b.id === parseInt(editBtn.dataset.id));
                if (book) showAddEditModal(book);
            } else if (deleteBtn) {
                const bookId = parseInt(deleteBtn.dataset.id);
                const book = books.find(b => b.id === bookId);
                 // Pastikan currentUserProfile ada dan admin
                 if (currentUserProfile && currentUserProfile.role === 'admin') {
                     showConfirmModal('Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus buku "${book.title}"?`, async () => {
                        const { error: deleteError } = await supabaseClient.from('books').delete().eq('id', bookId);
                        if (deleteError) {
                             console.error("Error deleting book:", deleteError);
                             showNotificationModal('Error', 'Gagal menghapus buku.');
                        } else {
                            // Log history (pastikan username benar)
                            await logHistoryAction('Hapus Buku', book.title, currentUserProfile.username);
                            showNotificationModal('Berhasil', `Buku "${book.title}" dihapus.`);
                        }
                        hideConfirmModal();
                        // Data akan ter-update otomatis via realtime subscription
                     });
                 }
            }
            if (returnBtn) handleReturn(parseInt(returnBtn.dataset.id));
            if (borrowBtn) handleBorrow(parseInt(borrowBtn.dataset.id));
            if (cancelBtn) handleCancelBooking(parseInt(cancelBtn.dataset.id));
        });
        
        userListTbody.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-user-btn');
            const deleteBtn = e.target.closest('.delete-user-btn');
            const viewHistoryBtn = e.target.closest('.view-history-btn');

            if(editBtn) {
                showEditUserModal(editBtn.dataset.id, editBtn.dataset.username, editBtn.dataset.role);
            }
            if(deleteBtn) {
                const userId = deleteBtn.dataset.id;
                const username = deleteBtn.dataset.username;
                showConfirmModal('Hapus Pengguna', `Apakah Anda yakin ingin menghapus pengguna "${username}"? Tindakan ini hanya menghapus profil, bukan akun login.`, async () => {
                     // Kita HANYA hapus profile, BUKAN auth user (karena butuh admin key)
                    const { error: profileDeleteError } = await supabaseClient.from('profiles').delete().eq('id', userId);
                    
                     if (profileDeleteError) {
                        console.error('Error deleting profile:', profileDeleteError);
                        showNotificationModal('Error', `Gagal menghapus profil pengguna: ${profileDeleteError.message}`);
                    } else {
                        showNotificationModal('Berhasil', `Profil pengguna ${username} telah dihapus.`);
                         // Refresh data pengguna setelah hapus profile
                         // Data akan update via realtime
                    }
                    hideConfirmModal();
                });
            }
            if(viewHistoryBtn) {
                showUserHistoryModal(viewHistoryBtn.dataset.username);
            }
        });

        closeModalBtn.addEventListener('click', hideDetailModal);
        
        addBookBtn.addEventListener('click', () => showAddEditModal());
        cancelFormBtn.addEventListener('click', hideAddEditModal);
        
        cancelUserFormBtn.addEventListener('click', hideEditUserModal);

        closeUserHistoryBtn.addEventListener('click', hideUserHistoryModal);

        bookCoverFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    coverPreview.src = event.target.result;
                    bookCoverUrlInput.value = event.target.result; // Store as base64 for now
                    // TODO: Idealnya upload ke Supabase Storage dan simpan URLnya
                };
                reader.readAsDataURL(file);
            }
        });

        addEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!currentUserProfile || currentUserProfile.role !== 'admin') {
                showNotificationModal('Error', 'Hanya admin yang dapat menambah/mengedit buku.');
                return;
            }
            const id = parseInt(document.getElementById('book-id').value);
            const bookData = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                category: document.getElementById('book-category').value,
                description: document.getElementById('book-description').value,
                coverUrl: bookCoverUrlInput.value || 'https://placehold.co/400x600/slate/ffffff?text=No+Image',
            };

            // Log data yang akan dikirim
            console.log("Data buku yang akan disimpan:", bookData);

             let error;
             let operationType = ''; // Untuk logging history
            if (id) {
                // Edit buku
                operationType = 'Edit Buku';
                console.log(`Mengupdate buku dengan ID: ${id}`);
                const { error: updateError } = await supabaseClient.from('books').update(bookData).eq('id', id);
                error = updateError;
            } else {
                 // Tambah buku baru
                 operationType = 'Tambah Buku';
                 console.log("Menambah buku baru");
                 // Hapus ID jika ada dari bookData sebelum insert
                 delete bookData.id;
                const { error: insertError } = await supabaseClient.from('books').insert([bookData]);
                 error = insertError;
            }

            if (error) {
                console.error(`Error saving book (${operationType}):`, error);
                // Cek jika errornya adalah tentang kolom tidak ditemukan
                if (error.message.includes('column') && error.message.includes('does not exist')) {
                     showNotificationModal('Error Database', `Kolom ${error.message.match(/column "(.*?)"/)?.[1] || 'tidak dikenal'} tidak ditemukan di tabel 'books'. Pastikan skema database Anda sudah benar.`);
                } else {
                    showNotificationModal('Error', `Gagal menyimpan buku: ${error.message}`);
                }
            } else {
                console.log(`Buku berhasil disimpan (${operationType})`);
                await logHistoryAction(operationType, bookData.title, currentUserProfile.username);
                hideAddEditModal();
                 // Data akan update via realtime, tidak perlu fetch ulang manual
            }
        });

        editUserForm.addEventListener('submit', async e => {
            e.preventDefault();
             if (!currentUserProfile || currentUserProfile.role !== 'admin') {
                showNotificationModal('Error', 'Hanya admin yang dapat mengubah peran.');
                return;
            }
            const id = document.getElementById('user-id-to-edit').value;
            const role = document.getElementById('user-role').value;
            userFormError.textContent = '';

            console.log(`Attempting to update profile ID: ${id} with role: ${role}`);
            const { error } = await supabaseClient.from('profiles').update({ role }).eq('id', id);

            if (error) {
                console.error("Error updating role:", error);
                userFormError.textContent = `Gagal memperbarui peran: ${error.message}`;
            } else {
                console.log(`Profile role updated successfully for ID: ${id}`);
                hideEditUserModal();
                 // Data profiles akan update via realtime
            }
        });

        confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        notificationOkBtn.addEventListener('click', hideNotificationModal);

        // --- AUTHENTICATION LOGIC ---
        showRegisterBtn.addEventListener('click', () => {
            loginFormContainer.classList.add('hidden');
            registerFormContainer.classList.remove('hidden');
            loginError.textContent = '';
        });
        showLoginBtn.addEventListener('click', () => {
            registerFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
            registerError.textContent = '';
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const identifier = loginIdentifierInput.value.trim(); // Bisa username atau email
            const password = loginForm.password.value;

            // --- Hardcoded Admin Check ---
            if (identifier === 'admin123' && password === 'admin123') {
                console.log("Hardcoded admin login attempt successful");
                 isHardcodedAdmin = true; // Set flag
                currentUserProfile = {
                    id: 'admin-hardcoded', username: 'admin123', role: 'admin'
                };
                 loginForm.reset();
                 await fetchInitialData(); // Panggil fetch data setelah set profile
                 showApp();
                 // Start realtime fallback polling
                 startRealtimeFallback();
                return;
            }
             // --- End of Hardcoded Admin Check ---

            // Jika bukan admin hardcoded, lanjutkan dengan Supabase Auth (menggunakan identifier sebagai email)
            console.log(`Mencoba login Supabase untuk email: "${identifier}"`); // Log email yang dicoba
            console.log(`Password yang dikirim: [${password.length} karakter]`); // Log panjang password

            try {
                 // NEW VALIDATION: Check if identifier is an email
                if (!identifier.includes('@')) {
                     // If user tries to login with username (no @), show clear error and stop
                     throw new Error("Untuk login Pengguna, silakan gunakan Alamat Email yang terdaftar, bukan username. (Kecuali Admin: admin123)");
                }

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                     email: identifier, // Asumsikan identifier adalah email untuk Supabase
                     password: password
                });

                if (error) throw error; // Lemparkan error untuk ditangkap di catch block
                
                console.log("Supabase Login successful, waiting for auth state change...");
                loginForm.reset();
                // onAuthStateChange akan dipicu dan memuat profile

            } catch (error) {
                 console.error("Supabase Login error:", error);
                 if (error.message.includes("Email not confirmed")) {
                     loginError.textContent = 'Email belum diverifikasi. Silakan cek inbox Anda.';
                 } else if (error.message.includes("Invalid login credentials")) {
                      // PERBAIKAN: Memberikan pesan error yang lebih jelas untuk memandu pengguna.
                      const errorMsg = `Kredensial tidak valid. Ingat: Pengguna login dengan EMAIL, Admin login dengan username 'admin123'.`;
                      console.error(`Login Gagal: Kredensial tidak valid untuk input '${identifier}'. ${errorMsg}`);
                      loginError.textContent = errorMsg;
                 } else {
                     loginError.textContent = `${error.message}`;
                 }
            }
        });

        registerForm.addEventListener('submit', async e => {
            e.preventDefault();
            registerError.textContent = '';
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;

            if (!username || !email || !password) {
                 registerError.textContent = 'Semua field wajib diisi.';
                 return;
            }
            if (password.length < 8) {
                registerError.textContent = 'Password harus minimal 8 karakter.';
                return;
            }

            // Cek apakah username sudah ada di tabel profiles
            try {
                console.log(`Checking if username exists: ${username}`);
                const { data: existingProfile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('username')
                    .eq('username', username)
                    .maybeSingle();
                
                 if (profileError) throw profileError; // Lemparkan error jika query gagal

                 console.log("Result of username check:", existingProfile);
                if (existingProfile) {
                    registerError.textContent = 'Username sudah digunakan. Silakan pilih username lain.';
                    return;
                }

                // Jika username belum ada, lanjutkan pendaftaran
                 console.log(`Username available. Proceeding with signup for email: ${email}`);
                const { data, error: signUpError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            username: username // Simpan username di metadata saat sign up
                        }
                    }
                });

                 if (signUpError) throw signUpError; // Lemparkan error jika sign up gagal

                 console.log("Sign up successful:", data);
                 // Tampilkan notifikasi berdasarkan apakah user perlu konfirmasi email
                 if (data.user && data.user.identities && data.user.identities.length === 0) {
                     showNotificationModal('Pendaftaran Berhasil', 'Silakan cek email Anda untuk verifikasi. Jika tidak ada, cek folder spam.');
                 } else {
                      showNotificationModal('Pendaftaran Berhasil', 'Akun Anda telah dibuat. Silakan login.');
                 }
                registerForm.reset();
                showLoginBtn.click();

            } catch (error) {
                 console.error("Registration process error:", error);
                 if (error.message.includes("User already registered")) {
                    registerError.textContent = "Email sudah terdaftar. Silakan login atau gunakan email lain.";
                 } else if (error.message.includes("duplicate key value violates unique constraint")) { // Jika trigger gagal & username duplikat di profiles
                     registerError.textContent = "Username sudah digunakan.";
                 } else if (error.message.includes("infinite recursion")) { // Tangkap error RLS di sini juga
                      registerError.textContent = "Terjadi masalah saat mendaftar (RLS recursion). Harap perbaiki kebijakan Supabase.";
                 }
                  else {
                    registerError.textContent = `Error: ${error.message}`;
                 }
            }
        });

        logoutBtn.addEventListener('click', async () => {
             if (isHardcodedAdmin) {
                 isHardcodedAdmin = false;
                 currentUserProfile = null;
                 // Stop fallback polling
                 if (realtimeFallbackInterval) clearInterval(realtimeFallbackInterval);
                 showLoginScreen();
                 console.log("Hardcoded admin logged out.");
             } else {
                const { error } = await supabaseClient.auth.signOut();
                 if (error) {
                     console.error("Error signing out:", error);
                     showNotificationModal('Error', 'Gagal logout.');
                 } else {
                     console.log("Supabase user signed out.");
                      // onAuthStateChange akan dipicu
                 }
             }
        });

        const showApp = () => {
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');

            if (currentUserProfile) {
                welcomeUserEl.textContent = `Hai, ${currentUserProfile.username}!`;
                if (currentUserProfile.role === 'admin') {
                    addBookBtn.classList.remove('hidden');
                    manageUserNavBtn.classList.remove('hidden');
                    reportsNavBtn.classList.remove('hidden');
                } else {
                    addBookBtn.classList.add('hidden');
                    manageUserNavBtn.classList.add('hidden');
                    reportsNavBtn.classList.add('hidden');
                }
                // Tampilkan halaman Beranda setelah memastikan profile ada
                showPage('home-page');
            } else {
                 welcomeUserEl.textContent = 'Memuat...';
                 // Mungkin tampilkan halaman loading atau nonaktifkan nav?
            }
        };


        const showLoginScreen = () => {
            currentUserProfile = null;
             isHardcodedAdmin = false;
            authScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
            loginForm.reset();
            registerForm.reset();
             loginError.textContent = '';
             registerError.textContent = '';
             // Reset data saat kembali ke login
             books = [];
             history = [];
             profiles = [];
             document.getElementById('book-grid').innerHTML = ''; // Kosongkan tampilan
             document.getElementById('newly-added-grid').innerHTML = '';
             document.getElementById('my-books-grid').innerHTML = '';
             document.getElementById('history-list').innerHTML = '';
             document.getElementById('borrowing-history-list').innerHTML = '';
             document.getElementById('user-list-tbody').innerHTML = '';
             console.log("Returned to login screen, local data reset.");
        }

        // --- INITIALIZATION & REALTIME ---
         const fetchInitialData = async () => {
            console.log("Fetching initial data...");
             let hasError = false; // Flag untuk melacak error

             // Ambil data buku
             try {
                const { data: bookData, error: bookError } = await supabaseClient.from('books').select('*').order('created_at', { ascending: false });
                 if (bookError) throw bookError;
                 books = bookData || [];
             } catch (bookError) {
                 console.error("Error fetching books:", bookError);
                 hasError = true;
                 if (bookError.message.includes("fetch")) {
                     showNotificationModal("Error Jaringan", "Gagal mengambil data buku. Cek URL Supabase Anda dan koneksi internet.");
                 }
             }

             // Ambil data riwayat
             try {
                 const { data: historyData, error: historyError } = await supabaseClient.from('history').select('*').order('timestamp', { ascending: false });
                 if (historyError) throw historyError;
                 history = historyData || [];
             } catch (historyError) {
                  console.error("Error fetching history:", historyError);
                  hasError = true;
                  if (historyError.message.includes("fetch")) {
                     showNotificationModal("Error Jaringan", "Gagal mengambil data riwayat. Cek URL Supabase Anda dan koneksi internet.");
                  }
             }


             // Ambil data profiles (penting untuk manajemen user oleh admin)
             if (currentUserProfile && currentUserProfile.role === 'admin' && !isHardcodedAdmin) {
                 try {
                    const { data: profilesData, error: profilesError } = await supabaseClient.from('profiles').select('*');
                     if (profilesError) throw profilesError;
                     profiles = profilesData || [];
                     rlsErrorMessage.classList.add('hidden'); // Sembunyikan pesan error RLS jika berhasil
                 } catch (profilesError) {
                     console.error("Error fetching profiles:", profilesError);
                     hasError = true;
                      // Tampilkan pesan error RLS jika itu masalahnya
                     if (profilesError.message.includes("infinite recursion")) {
                         rlsErrorMessage.classList.remove('hidden');
                     }
                 }
             } else if (isHardcodedAdmin) {
                 // Admin hardcoded tidak bisa fetch profiles karena tidak punya auth.uid() Supabase
                 console.warn("Hardcoded admin cannot fetch profiles list due to RLS.");
                 // Kita bisa tampilkan pesan di halaman manage user
                 profiles = []; // Kosongkan profiles
             }


             console.log("Initial data fetched. Books:", books.length, "History:", history.length, "Profiles:", profiles.length, "Has Error:", hasError);
             
             // Render ulang halaman aktif setelah data diambil
             const activePage = document.querySelector('.page:not(.hidden)');
             if (activePage) {
                 showPage(activePage.id); // Ini akan memicu render function yang sesuai
             } else if (currentUserProfile) {
                 showPage('home-page'); // Default ke home
             }
        };


        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log(`Auth event: ${event}`, session ? `User ID: ${session.user.id}` : 'No session');
             // Abaikan jika login admin hardcoded sedang aktif
             if (isHardcodedAdmin) {
                 console.log("Auth change ignored due to hardcoded admin session.");
                 return;
             }

            if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session) {
                 // Cek apakah profile sudah ada DAN sesuai dengan user saat ini
                 if (!currentUserProfile || currentUserProfile.id !== session.user.id) {
                     console.log("Fetching profile for user:", session.user.id);
                     try {
                         const { data, error } = await supabaseClient
                             .from('profiles')
                             .select('*')
                             .eq('id', session.user.id)
                             .single();

                         if (error) throw error; // Lemparkan error untuk ditangkap di catch block

                         if (data) {
                             console.log(`Profile loaded on ${event}:`, data);
                             currentUserProfile = data;
                             await fetchInitialData(); // Panggil fetch data setelah set profile
                             showApp();
                             // Start polling as fallback
                             startRealtimeFallback();
                         } else {
                            // Kasus aneh, tidak ada error tapi data null (mungkin trigger belum selesai?)
                            console.warn(`Profile fetch on ${event} returned null data without error. Retrying once...`);
                            // Coba tunggu 1 detik dan fetch lagi
                            await new Promise(resolve => setTimeout(resolve, 1000)); 
                            const { data: retryData, error: retryError } = await supabaseClient
                                 .from('profiles')
                                 .select('*')
                                 .eq('id', session.user.id)
                                 .single();
                             
                             if (retryData) {
                                 console.log(`Profile loaded on retry:`, retryData);
                                 currentUserProfile = retryData;
                                 await fetchInitialData();
                                 showApp();
                                 startRealtimeFallback();
                             } else {
                                 console.error("Profile still null on retry. Signing out.", retryError || "No data");
                                 await supabaseClient.auth.signOut();
                                 showNotificationModal('Error', 'Gagal memuat profil pengguna setelah mendaftar. Silakan coba login kembali.');
                             }
                         }
                     } catch (error) {
                         console.error(`Error fetching profile on ${event}:`, error);
                         if (error.code === 'PGRST116') { // Not found (trigger belum selesai)
                             console.warn("Profile not found yet. Trigger might be delayed. Retrying once...");
                              // Coba tunggu 1 detik dan fetch lagi
                            await new Promise(resolve => setTimeout(resolve, 1000));
                             const { data: retryData, error: retryError } = await supabaseClient
                                 .from('profiles')
                                 .select('*')
                                 .eq('id', session.user.id)
                                 .single();
                             
                             if (retryData) {
                                 console.log(`Profile loaded on retry:`, retryData);
                                 currentUserProfile = retryData;
                                 await fetchInitialData();
                                 showApp();
                                 startRealtimeFallback();
                             } else {
                                  console.error("Profile still null on retry (PGRST116). Signing out.", retryError || "No data");
                                 await supabaseClient.auth.signOut();
                                 showNotificationModal('Error', 'Gagal memuat profil pengguna setelah mendaftar. Silakan coba login kembali.');
                             }
                         } else if (error.message.includes("infinite recursion")) { // Tangkap error RLS
                              console.error("RLS Infinite Recursion detected while fetching profile!");
                              showNotificationModal("Error Kritis", "Terdeteksi masalah konfigurasi RLS (infinite recursion) saat memuat profil. Harap perbaiki kebijakan Supabase Anda.");
                              currentUserProfile = { id: session.user.id, username: 'Error RLS', role: 'user' }; // Tampilkan state error
                              await fetchInitialData(); // Coba fetch data lain
                              showApp(); // Tetap tampilkan app sebisa mungkin
                         }
                         else {
                             await supabaseClient.auth.signOut();
                             showNotificationModal('Error', `Gagal memuat profil penting: ${error.message}`);
                         }
                     }
                 } else {
                      // Profile sudah ada dan sesuai, tidak perlu fetch ulang profile
                      console.log("Profile already loaded and matches current session.");
                      await fetchInitialData(); // Fetch data buku, history, dll
                      showApp(); // Pastikan UI ditampilkan
                      startRealtimeFallback();
                 }
            } else if (event === 'SIGNED_OUT') {
                console.log("User signed out.");
                showLoginScreen();
            }
             // Anda bisa menambahkan handler untuk event lain seperti 'PASSWORD_RECOVERY', 'USER_UPDATED' jika perlu
        });

        // --- REALTIME FALLBACK ---
        const startRealtimeFallback = () => {
             if (realtimeFallbackInterval) return; // Sudah jalan
             console.log("Starting realtime fallback polling (every 15s)...");
             realtimeFallbackInterval = setInterval(() => {
                 console.log("Polling data update...");
                 fetchInitialData();
             }, 15000); // Poll every 15 seconds
        };

        // Real-time subscriptions
        const booksSubscription = supabaseClient.channel('public:books')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'books' }, (payload) => {
              console.log('Book change received!', payload);
               // Cara sederhana: fetch ulang semua buku
               fetchInitialData(); // Fetch ulang semua data agar konsisten
          })
          .subscribe((status, err) => {
              if (status === 'SUBSCRIBED') {
                console.log('Connected to books channel!');
              } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
                console.error('Failed to connect to books channel:', status, err || '');
                 // Fallback to polling if realtime fails
                 startRealtimeFallback();
              }
          });

        const historySubscription = supabaseClient.channel('public:history')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'history' }, (payload) => {
              console.log('History change received!', payload);
               fetchInitialData(); // Fetch ulang semua data
          })
           .subscribe((status, err) => {
              if (status === 'SUBSCRIBED') {
                console.log('Connected to history channel!');
              } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
                console.error('Failed to connect to history channel:', status, err || '');
                startRealtimeFallback();
              }
          });

        const profilesSubscription = supabaseClient.channel('public:profiles')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, (payload) => {
              console.log('Profile change received!', payload);
                // Fetch ulang semua profiles untuk update tabel manajemen user dan data user saat ini
               fetchInitialData();

               // Update currentUserProfile jika yang berubah adalah user saat ini
               if (!isHardcodedAdmin && currentUserProfile && payload.new && payload.new.id === currentUserProfile.id) {
                    console.log("Current user's profile updated by subscription:", payload.new);
                    currentUserProfile = payload.new;
                    // Mungkin perlu update UI spesifik seperti welcome message jika hanya username berubah
                    welcomeUserEl.textContent = `Hai, ${currentUserProfile.username}!`;
                    // Periksa apakah peran berubah dan sesuaikan UI admin/user
                    if (currentUserProfile.role === 'admin') {
                         addBookBtn.classList.remove('hidden');
                         manageUserNavBtn.classList.remove('hidden');
                         reportsNavBtn.classList.remove('hidden');
                    } else {
                         addBookBtn.classList.add('hidden');
                         manageUserNavBtn.classList.add('hidden');
                         reportsNavBtn.classList.add('hidden');
                    }
               }
          })
           .subscribe((status, err) => {
              if (status === 'SUBSCRIBED') {
                console.log('Connected to profiles channel!');
              } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
                console.error('Failed to connect to profiles channel:', status, err || '');
                startRealtimeFallback();
              }
          });

         // Hapus listener saat halaman ditutup
         window.addEventListener('beforeunload', () => {
             console.log("Removing Supabase channels before unload.");
             supabaseClient.removeChannel(booksSubscription);
             supabaseClient.removeChannel(historySubscription);
             supabaseClient.removeChannel(profilesSubscription);
             if (realtimeFallbackInterval) clearInterval(realtimeFallbackInterval);
         });

         // Panggil fetchInitialData sekali di awal (jika tidak ada session aktif, tidak akan melakukan apa2 sampai login)
         // fetchInitialData(); // Sebaiknya dipanggil setelah auth state change pertama kali

    });
    </script>
</body>
</html>
